name: Backend Multi-Branch Pipeline

on:
  push:
    branches:
      - master       # Production
      - staging      # Staging environment
      - develop      # Development
      - feature/**   # Feature branches

jobs:
  build:
    runs-on: self-hosted
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Debug Repository Structure
        run: ls -R

      - name: Build Backend Docker Image
        run: |
          docker build -t backend:${{ github.ref_name }} -t backend:latest .

  deploy:
    runs-on: self-hosted
    needs: build
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/develop'
    steps:
      - name: Stop and Remove Existing Container
        run: |
          docker stop backend-${{ github.ref_name }} || true
          docker rm backend-${{ github.ref_name }} || true

      - name: Run Backend Container
        run: |
          docker run -d \
            --name backend-${{ github.ref_name }} \
            -p 5000:5000 \
            -e ENVIRONMENT=${{ github.ref_name }} \
            backend:${{ github.ref_name }}

  test:
    runs-on: self-hosted
    needs: build
    if: startsWith(github.ref, 'refs/heads/feature/') || github.ref == 'refs/heads/develop'
    steps:
      - name: Run Unit Tests
        run: |
          docker run --rm backend:${{ github.ref_name }} npm test

      - name: Run Integration Tests
        if: github.ref == 'refs/heads/develop'
        run: |
          docker run --rm -e NODE_ENV=test backend:${{ github.ref_name }} npm run test:integration
